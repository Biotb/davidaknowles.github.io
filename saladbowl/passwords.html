<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <title>Bugout chat tutorial</title>
  <style>
    body { background-color: #333; font-size: 1.5em; padding: 0em 0.25em; }
    pre { color: #fff; white-space: pre-wrap; word-wrap: break-word; text-shadow: 0 0 10px #ccc; }
    #input { border-bottom: 1px solid #ccc; background-color: #383838; padding: 0.25em; outline: 0; }
  </style>
  <script src="https://chr15m.github.io/bugout/bugout.min.js" type="application/javascript"></script>
</head>
<body>
  <pre id="log"></pre>
  <pre id="input" contenteditable="true"></pre>
</body>
<script>
  function log(message) {
    document.getElementById("log").textContent += message + "\n";
  }

  log("Welcome to Salad Bowl!");
  log("Don't refresh this window unless you want to reset the game!")

  var serveraddress = window.location.hash.substr(1);
  var b = Bugout(serveraddress, {"announce": ["wss://hub.bugout.link"]});  // wss://tracker.openwebtorrent.com
  var isserver = serveraddress=="";
  
  log("What's your name friend?");

  var players = {};

  var state = "name";

  var name = "";

  var my_words = [];

  if (isserver) {
    all_words = [];
    words_received_check = [];
    b.register("join", function(address, message, cb) {
      if (message.length <= 1) { cb(false); return };
      their_name = message[0];
      if (password == message[1]) {
        players[address] = their_name;
        log(their_name + " joined!");
        cb(true);
      } else {
        cb(false);
      }
    })

    b.register("words", function(address, message, cb) {
      if (!(address in players)) return;
      all_words.concat(message);
      log(players[address] + " submitted their words!")
      words_received_check.push(address);
    })
  }

  document.getElementById("input").onkeydown = function(ev) {
    var should_reset = true; 
    if (ev.keyCode == 13) {
      if (state == "name") {
        name = ev.target.textContent;
        log("Hi " + name + "!")
        if (isserver) {
          players[b.address] = name;
          log("Set a password for your room:");
        } else {
          log("Enter the room password:")
        }
        state = "password"
      } else if (state == "password") {
        password = ev.target.textContent;
        if (isserver) {
          log("Tell your friends to connect here:");
          log(document.location.href + "#" + b.address());
          state = "choose_words"
          log("Once everyone has joined enter your words/phrases separated by commas! Min 3, max 5. Don't tell anyone what they are.")
        } else {
          log("Checking password...");
          b.rpc("join", [name,password], correct => {
            if (correct) {
              log("Password correct!")
              log("Enter your words/phrases separated by commas! Min 3, max 5. Don't tell anyone what they are.")
              state = "choose_words"
            } else {
              log("Wrong password! Try again.")
            }
          });
        }
      } else if (state == "choose_words") {
        my_words = ev.target.textContent.split(",").map(g => g.trim()); 
        if (my_words.length < 3) {
          log("Too few words/phrases (min 3)!"); 
          should_reset = false; 
        } else if (my_words.length > 5) {
          log("Too many words/phrases (max 5)!"); 
          should_reset = false; 
        } else {
          log(my_words);
          log("Waiting for other players to enter their words.");
          b.rpc("words", my_words)
          state = "waiting";
        }
      } 
      if (should_reset) { ev.target.textContent = ""; }
      ev.preventDefault();
    } 
  }

</script>
</html>
